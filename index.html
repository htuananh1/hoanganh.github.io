<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>UGPHONE Auto Trial Menu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #181818;
      min-height: 100vh;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #f8f9fa;
      user-select: none;
    }
    /* Hamburger */
    #ug-menu-btn {
      position: fixed;
      top: 32px;
      right: 32px;
      z-index: 9999;
      width: 56px;
      height: 56px;
      background: rgba(30,31,44,0.75);
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px #000a;
      transition: background 0.18s;
      outline: none;
    }
    #ug-menu-btn:hover { background: rgba(45,55,85,0.9);}
    .ug-hamburger {
      width: 36px;
      height: 36px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 9px;
    }
    .ug-hamburger-bar {
      width: 30px;
      height: 3px;
      background: #fff;
      border-radius: 3px;
      transition: all 0.18s;
    }
    /* Menu modal */
    #ug-menu-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 10000;
      background: rgba(0,0,0,0.32);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0;}
      to { opacity: 1;}
    }
    .ug-modal-content {
      background: #23273b;
      border-radius: 18px;
      min-width: 325px;
      max-width: 92vw;
      padding: 2.2rem 1.5rem 1.4rem 1.5rem;
      box-shadow: 0 6px 32px #0007;
      border: 2px solid #00f2fe55;
      position: relative;
      text-align: center;
    }
    .ug-modal-content h2 {
      color: #00f2fe;
      background: linear-gradient(to right, #00f2fe, #2575fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: inline-block;
      font-size: 1.25rem;
      margin-bottom: 1.2rem;
      letter-spacing: 0.03em;
    }
    .ug-modal-content label {
      display: inline-block;
      margin-right: 6px;
      color: #aeefff;
      font-weight: 600;
      font-size: 1.01rem;
    }
    .ug-modal-content select {
      background: #23293b;
      color: #e2e7ef;
      border: 1.5px solid #485571;
      border-radius: 7px;
      padding: 4px 15px 4px 7px;
      font-size: 1.04rem;
      margin-bottom: 20px;
      margin-top: 2px;
      outline: none;
      transition: border 0.21s;
    }
    .ug-modal-content select:focus { border-color: #5f85fa;}
    .ug-modal-content .ug-btn {
      margin-top: 16px;
      background: linear-gradient(to right, #5f85fa, #2575fc);
      color: #fff;
      border: none;
      border-radius: 100px;
      font-size: 1.08rem;
      padding: 0.69rem 2.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 2px 14px #00f2fe33;
    }
    .ug-modal-content .ug-btn:hover {
      background: linear-gradient(to right, #2575fc, #00f2fe);
      filter: brightness(1.10);
    }
    .ug-modal-content .ug-close {
      position: absolute;
      top: 14px; right: 16px;
      background: transparent;
      color: #00f2fe;
      border: none;
      font-size: 1.5rem;
      font-weight: 700;
      cursor: pointer;
      padding: 3px 7px;
      transition: color 0.16s;
    }
    .ug-modal-content .ug-close:hover { color: #fff; }
    .ug-modal-content .ug-status {
      margin-top: 1.1rem;
      font-size: 1.08rem;
      color: #ff487a;
      min-height: 1.2em;
      font-weight: 600;
    }
    .ug-modal-content .ug-status.success { color: #1fff9f;}
    .ug-modal-content textarea {
      width: 95%;
      margin: 0 auto 10px auto;
      display: block;
      height: 92px;
      background: #192135;
      color: #eafcff;
      border-radius: 8px;
      border: 1.5px solid #485571;
      font-size: 0.99rem;
      padding: 7px 12px;
      outline: none;
      font-family: 'Fira Mono', 'Consolas', monospace;
      transition: border 0.18s;
      resize: none;
    }
    .ug-modal-menu {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin-bottom: 1.4rem;
      margin-top: -0.8rem;
    }
    .ug-modal-menu a {
      color: #00f2fe;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.05rem;
      letter-spacing: 0.01em;
      transition: color 0.14s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .ug-modal-menu a:hover {
      color: #fff;
      text-shadow: 0 0 6px #00f2fe, 0 0 2px #fff;
    }
    .arx-tip {
      background: rgba(0,242,254,0.11);
      border: 1.5px solid #00f2fe33;
      border-radius: 12px;
      color: #00f2fe;
      text-align: left;
      font-size: 0.98rem;
      padding: 1.1rem 1.1rem 1rem 1.3rem;
      margin-bottom: 1.3rem;
      margin-top: 0.6rem;
      box-shadow: 0 2px 12px #00f2fe15;
      max-width: 440px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.7;
    }
    .arx-tip b { color: #fff; }
    .arx-tip ul {
      padding-left: 1.1em;
      margin: 0.4em 0 0.5em 0;
    }
    .arx-tip li {
      margin-bottom: 0.2em;
    }
    /* Responsive */
    @media (max-width: 500px) {
      #ug-menu-btn { top:10px; right:10px; width:48px; height:48px; }
      .ug-hamburger { width: 25px; height: 25px; gap: 7px;}
      .ug-hamburger-bar { width: 20px; }
      .ug-modal-content { min-width: 0; padding:1.1rem 0.5rem;}
      .ug-modal-menu { gap: 8px; font-size: 0.98rem;}
      .arx-tip { padding: 0.7rem 0.4rem 0.7rem 0.6rem; font-size: 0.91rem; }
    }
  </style>
</head>
<body>
  <!-- Hamburger button -->
  <button id="ug-menu-btn" title="Menu UGPhone">
    <span class="ug-hamburger">
      <span class="ug-hamburger-bar"></span>
      <span class="ug-hamburger-bar"></span>
      <span class="ug-hamburger-bar"></span>
    </span>
  </button>
  <!-- Modal -->
  <div id="ug-menu-modal">
    <div class="ug-modal-content">
      <button class="ug-close" id="ug-close-btn">&times;</button>
      <div class="ug-modal-menu">
        <a href="/" title="Trang chủ"><i class="fas fa-home"></i> Home</a>
        <a href="https://www.ugphone.com/toc-portal/#/login" target="_blank"><i class="fas fa-user"></i> Đăng nhập</a>
        <a href="https://www.ugphone.com/toc-portal/#/dashboard/index" target="_blank"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      </div>
      <div class="arx-tip">
        <b>Hướng dẫn sử dụng Arceus X:</b>
        <ul>
          <li><b>1.</b> Tải <a style="color:#00f2fe;text-decoration:underline" href="https://vng.spdmteam.com/" target="_blank">bản mới nhất Arceus X</a> về điện thoại Android.</li>
          <li><b>2.</b> Cài đặt ứng dụng, nếu bị chặn hãy vào <b>Cài đặt &gt; Bảo mật</b> cho phép cài app ngoài CHPlay.</li>
          <li><b>3.</b> Sau khi cài xong, mở Arceus X và cấp quyền nếu được hỏi.</li>
          <li><b>4.</b> Tải script, copy và dán vào phần <b>Executor</b> của Arceus X trong game Roblox.</li>
          <li><b>5.</b> Nhấn <b>Execute</b> để chạy script, tận hưởng các tính năng hỗ trợ!</li>
        </ul>
        <b>Lưu ý:</b> Hãy luôn tải bản Arceus X chính chủ từ website trên để tránh mất tài khoản!
      </div>
      <h2><i class="fas fa-mobile-alt"></i> UGPHONE Auto Trial</h2>
      <label for="ug-server-select">Chọn server:</label>
      <select id="ug-server-select">
        <option value="">Random</option>
        <option value="Singapore">Singapore</option>
        <option value="Hong Kong">Hong Kong</option>
        <option value="Japan">Japan</option>
        <option value="America">America</option>
        <option value="Germany">Germany</option>
      </select>
      <br>
      <label for="ug-ls">Dán localStorage JSON (nếu cần):</label>
      <textarea id="ug-ls" placeholder="Dán dữ liệu localStorage tại đây..."></textarea>
      <br>
      <button class="ug-btn" id="ug-autobuy-btn"><i class="fas fa-bolt"></i> Auto mua máy trial</button>
      <div class="ug-status" id="ug-status"></div>
    </div>
  </div>
  <!-- Font Awesome CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
  <script>
    // Elements
    const menuBtn = document.getElementById("ug-menu-btn");
    const modal = document.getElementById("ug-menu-modal");
    const closeBtn = document.getElementById("ug-close-btn");
    const serverSelect = document.getElementById("ug-server-select");
    const lsTextarea = document.getElementById("ug-ls");
    const autoBuyBtn = document.getElementById("ug-autobuy-btn");
    const statusEl = document.getElementById("ug-status");

    // Show/hide modal
    menuBtn.onclick = () => { modal.style.display = "flex"; }
    closeBtn.onclick = () => { modal.style.display = "none"; statusEl.textContent = ''; }

    // Dán localStorage JSON nếu có
    lsTextarea.onblur = () => {
      const txt = lsTextarea.value.trim();
      if (txt) {
        try {
          const obj = JSON.parse(txt);
          Object.entries(obj).forEach(([k, v]) =>
            localStorage.setItem(k, typeof v === "object" ? JSON.stringify(v) : String(v))
          );
          statusEl.textContent = "Đã import localStorage!";
          statusEl.classList.add("success");
          setTimeout(() => { statusEl.textContent = ""; statusEl.classList.remove("success"); }, 1300);
        } catch {
          statusEl.textContent = "JSON không hợp lệ!";
          statusEl.classList.remove("success");
        }
      }
    };

    // Auto mua logic
    function showStatus(msg, ok=false) {
      statusEl.textContent = msg;
      if (ok) statusEl.classList.add("success");
      else statusEl.classList.remove("success");
    }
    function fastXhrRequest(method, url, data, headers, timeout=4000) {
      return new Promise((resolve, reject) => {
        let didFinish = false;
        const timer = setTimeout(() => { if (!didFinish) { didFinish = true; reject(new Error('Timeout')); } }, timeout);
        if (window.fetch) {
          fetch(url, {
            method,
            headers,
            credentials: 'include',
            body: data ? JSON.stringify(data) : undefined,
          })
          .then(r => r.json())
          .then(json => { if (!didFinish) { didFinish = true; clearTimeout(timer); resolve(json); } })
          .catch(e => { if (!didFinish) { didFinish = true; clearTimeout(timer); reject(e); } });
        } else {
          const xhr = new XMLHttpRequest();
          xhr.open(method, url, true);
          xhr.withCredentials = true;
          for (const key in headers) xhr.setRequestHeader(key, headers[key]);
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              if (!didFinish) {
                didFinish = true; clearTimeout(timer);
                if (xhr.status >= 200 && xhr.status < 300) {
                  try { resolve(JSON.parse(xhr.responseText)); } catch (e) { reject(e); }
                } else { reject(new Error('Status '+xhr.status)); }
              }
            }
          };
          xhr.send(data ? JSON.stringify(data) : null);
        }
      });
    }
    const sleep = ms => new Promise(res=>setTimeout(res,ms));

    let stopAuto = false;
    autoBuyBtn.onclick = async () => {
      if (autoBuyBtn.disabled) return;
      autoBuyBtn.disabled = true;
      stopAuto = false;
      autoBuyBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang mua... (bấm lại để DỪNG)`;
      autoBuyBtn.onclick = () => { stopAuto = true; showStatus("Đã dừng auto mua!"); autoBuyBtn.onclick = null; };

      try {
        const serverValue = serverSelect.value;
        const servers = ["Singapore", "Hong Kong", "Japan", "America", "Germany"];
        let orderList = servers.filter(s => s !== serverValue);
        let ordered = [];
        if (serverValue) ordered.push(serverValue);
        ordered = ordered.concat(orderList);
        ordered.push(""); // Random cuối

        const mqtt = JSON.parse(localStorage.getItem('UGPHONE-MQTT') || '{}');
        const headers = {
          'accept': 'application/json, text/plain, */*',
          'accept-language': 'vi-VN,vi;q=0.9',
          'content-type': 'application/json;charset=UTF-8',
          'lang': 'vi',
          'terminal': 'web',
          'access-token': mqtt.access_token,
          'login-id': mqtt.login_id
        };

        let bought = false;
        showStatus("Đang auto mua máy trial...", true);

        while (!bought && !stopAuto) {
          for (let svIdx = 0; svIdx < ordered.length && !bought && !stopAuto; svIdx++) {
            const selectedServer = ordered[svIdx];
            // Step 1: config_id
            let config_id = null;
            for (let attempt = 0; attempt < 3 && !config_id && !stopAuto; ++attempt) {
              try {
                const json1 = await fastXhrRequest('GET', 'https://www.ugphone.com/api/apiv1/info/configList2', null, headers, 3000);
                let list1 = Array.isArray(json1.data?.list) ? json1.data.list : json1.data;
                if (!Array.isArray(list1)) {
                  const arr = Object.values(json1.data || {}).find(v => Array.isArray(v));
                  list1 = Array.isArray(arr) ? arr : [];
                }
                if (list1?.[0]?.android_version?.[0]?.config_id) config_id = list1[0].android_version[0].config_id;
              } catch {}
            }
            if (!config_id) { await sleep(400); continue; }

            // Step 2: meal/subscription
            let subscriptions = [];
            for (let attempt = 0; attempt < 3 && subscriptions.length === 0 && !stopAuto; ++attempt) {
              try {
                const json2 = await fastXhrRequest('POST', 'https://www.ugphone.com/api/apiv1/info/mealList', { config_id }, headers, 3000);
                let subData = json2.data?.list;
                if (Array.isArray(subData)) subscriptions = subData.flatMap(i => i.subscription || []);
                else if (subData?.subscription) subscriptions = subData.subscription;
              } catch {}
            }
            if (!subscriptions.length) { await sleep(400); continue; }
            let filteredSubs = subscriptions;
            if (selectedServer) {
              filteredSubs = subscriptions.filter(sub => (sub?.network_name || '').toLowerCase().includes(selectedServer.toLowerCase()));
              if (!filteredSubs.length) { await sleep(400); continue; }
            }

            for (const net_id of filteredSubs.map(o => o.network_id)) {
              let amount_id;
              try {
                const priceJson = await fastXhrRequest('POST', 'https://www.ugphone.com/api/apiv1/fee/queryResourcePrice', {
                  order_type: 'newpay', period_time: '4', unit: 'hour', resource_type: 'cloudphone',
                  resource_param: { pay_mode: 'subscription', config_id, network_id: net_id, count: 1, use_points: 3, points: 250 }
                }, headers, 1800);
                amount_id = priceJson.data?.amount_id;
                if (!amount_id) continue;
              } catch { continue; }
              try {
                const payJson = await fastXhrRequest('POST', 'https://www.ugphone.com/api/apiv1/fee/payment', { amount_id, pay_channel: 'free' }, headers, 1800);
                if (payJson.code === 200) {
                  showStatus('Đã mua thành công!', true);
                  bought = true;
                  modal.style.display = "none";
                  break;
                }
              } catch {}
            }
            if (!bought && !stopAuto) await sleep(180 + Math.random() * 120);
          }
        }
        if (!bought && !stopAuto) showStatus('Không mua được máy. Tiếp tục thử...', false);
      } catch (e) {
        showStatus("Lỗi: " + (e.message || e));
      } finally {
        autoBuyBtn.disabled = false;
        autoBuyBtn.innerHTML = `<i class="fas fa-bolt"></i> Auto mua máy trial`;
        autoBuyBtn.onclick = autoBuyBtnClick;
      }
    };
    // For re-entrancy
    function autoBuyBtnClick() { autoBuyBtn.onclick = autoBuyBtnClick; autoBuyBtn.dispatchEvent(new Event('click')); }
    autoBuyBtn.onclick = autoBuyBtnClick;
  </script>
</body>
</html>
